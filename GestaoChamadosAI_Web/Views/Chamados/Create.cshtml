@model GestaoChamadosAI_Web.Models.Chamado

@{
    ViewData["Title"] = "Abrir Chamado";
    if (User.IsInRole("Cliente"))
    {
        Layout = "~/Views/Shared/_LayoutCliente.cshtml";
    }
}

<div class="@(User.IsInRole("Cliente") ? "cliente-card" : "") mb-3">
    <div class="row">
        <div class="col">
            <h2 class="mb-0">
                @if (User.IsInRole("Cliente"))
                {
                    <text>✍️ Abrir Chamado</text>
                }
                else
                {
                    <text><i class="bi bi-plus-circle-fill text-primary"></i> Abrir Novo Chamado</text>
                }
            </h2>
            <p class="text-muted">
                @if (User.IsInRole("Cliente"))
                {
                    <text>Descreva seu problema que vamos te ajudar</text>
                }
                else
                {
                    <text>Preencha os campos abaixo para abrir um chamado de suporte</text>
                }
            </p>
        </div>
    </div>
</div>

<div class="@(User.IsInRole("Cliente") ? "cliente-card" : "")">
    <div class="row">
    <div class="col-12 col-lg-8 mb-4 order-1 order-lg-1">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                @if (TempData["Erro"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> @TempData["Erro"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                    
                    <!-- Título -->
                    <div class="mb-4">
                        <label for="Titulo" class="form-label fw-bold">
                            <i class="bi bi-ticket-detailed text-primary"></i> Título do Problema *
                        </label>
                        <input asp-for="Titulo" class="form-control form-control-lg" 
                               placeholder="Ex: Computador muito lento, senha náo funciona..." 
                               maxlength="200" required />
                        <span asp-validation-for="Titulo" class="text-danger small"></span>
                        <div class="form-text">
                            <i class="bi bi-lightbulb"></i> Seja claro e específico
                        </div>
                    </div>

                    <!-- Descriçáo -->
                    <div class="mb-4">
                        <label for="Descricao" class="form-label fw-bold">
                            <i class="bi bi-file-text text-primary"></i> Descriçáo Detalhada *
                        </label>
                        <textarea asp-for="Descricao" class="form-control" rows="6" 
                                  placeholder="Descreva o problema em detalhes:&#10;- O que aconteceu?&#10;- Quando começou?&#10;- Já tentou alguma soluçáo?&#10;- Há mensagens de erro?" required></textarea>
                        <span asp-validation-for="Descricao" class="text-danger small"></span>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Quanto mais detalhes, melhor será a análise da IA
                        </div>
                    </div>

                    <hr class="my-4" />

                    <!-- Botões de ação -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg w-100 w-md-auto">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                        <button type="submit" id="btnSubmit" class="btn btn-primary btn-lg px-5 w-100 w-md-auto">
                            <i class="bi bi-check-circle-fill"></i> Abrir Chamado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Painel lateral -->
    <div class="col-12 col-lg-4 mb-4 order-2 order-lg-2">
        <!-- Card de Dicas -->
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body">
                <h6 class="fw-bold mb-3">
                    <i class="bi bi-lightbulb text-warning"></i> Dicas para um bom chamado
                </h6>
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        <small>Use título claro e objetivo</small>
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        <small>Descreva quando o problema começou</small>
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        <small>Mencione mensagens de erro</small>
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        <small>Informe o que já tentou fazer</small>
                    </li>
                    <li class="mb-0">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        <small>Seja detalhado na descriçáo</small>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Exemplos -->
        <div class="card shadow-sm border-0 mt-3">
            <div class="card-body">
                <h6 class="fw-bold mb-3">
                    <i class="bi bi-question-circle text-info"></i> Exemplos de problemas
                </h6>
                <div class="mb-2">
                    <span class="badge bg-secondary mb-1">Acesso</span>
                    <small class="d-block text-muted">Esqueci minha senha</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-secondary mb-1">Performance</span>
                    <small class="d-block text-muted">Computador muito lento</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-secondary mb-1">Rede</span>
                    <small class="d-block text-muted">Sem acesso à internet</small>
                </div>
                <div class="mb-0">
                    <span class="badge bg-secondary mb-1">Impressáo</span>
                    <small class="d-block text-muted">Impressora náo funciona</small>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Modal de Loading da IA -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                        <span class="visually-hidden">Processando...</span>
                    </div>
                </div>
                <h5 class="mb-3">
                    <i class="bi bi-robot"></i> IA Analisando seu Chamado
                </h5>
                <p class="text-muted mb-2">Aguarde enquanto processamos suas informações...</p>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 100%"></div>
                </div>
                <p class="text-muted small mt-3 mb-0">
                    <span class="loading-dots">Isso pode levar alguns segundos</span>
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        .loading-dots::after {
            content: '';
            animation: loadingDots 1.5s infinite;
        }
        
        @@keyframes loadingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
    
    <script>
        // Exibe modal de loading ao submeter formulário
        document.addEventListener('DOMContentLoaded', function() {
            var form = document.querySelector('form');
            
            form.addEventListener('submit', function(e) {
                // Valida o formulário antes de mostrar o loading
                if (form.checkValidity()) {
                    var modal = new bootstrap.Modal(document.getElementById('loadingModal'));
                    modal.show();
                    
                    // Desabilita botão de submit
                    document.getElementById('btnSubmit').disabled = true;
                }
            });
        });
    </script>
    
    <!-- Validação do lado do cliente -->
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}