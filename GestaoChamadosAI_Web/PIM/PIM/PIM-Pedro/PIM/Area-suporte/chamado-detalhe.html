<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Atendente • Detalhe do chamado</title>
  <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/css/theme.css" rel="stylesheet">
</head>
<body data-page="a-chamado-detalhe">
  <div class="app-wrapper">
    <nav class="sidebar d-flex flex-column">
      <div class="brand">
        <button class="btn btn-sm btn-light d-lg-none me-2" data-toggle="sidebar"><i class="bi bi-list"></i></button>
        <img src="../assets/img/logo.png" alt="" onerror="this.style.display='none'">
        <span class="brand-name">PIM</span>
      </div>
      <ul class="nav nav-pills flex-column gap-1">
        <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a></li>
        <li class="nav-item"><a class="nav-link" href="chamados.html"><i class="bi bi-ticket-detailed"></i><span>Meus Chamados</span></a></li>
  <li class="nav-item"><a class="nav-link" href="relatorios.html"><i class="bi bi-graph-up"></i><span>Relatórios</span></a></li>
  <!-- Item Configurações removido -->
      </ul>
    </nav>

    <nav class="app-header navbar navbar-light bg-white px-3">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-secondary d-none d-lg-inline" title="Recolher" data-toggle="collapse-sidebar"><i class="bi bi-layout-sidebar-inset"></i></button>
        <button class="btn btn-outline-secondary d-lg-none" data-toggle="sidebar"><i class="bi bi-list"></i></button>
      </div>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="header-chip d-none d-md-inline">SLA: 4h resposta</span>
        <div class="dropdown">
          <a class="nav-link position-relative" href="#" title="Notificações" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-bell"></i>
            <span class="notif-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
          </a>
          <div class="dropdown-menu dropdown-menu-end p-0 notif-menu"></div>
        </div>
        <div class="dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i class="bi bi-person-circle me-1"></i> Você</a>
          <div class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" href="perfil.html">Perfil</a>
          </div>
        </div>
      </div>
    </nav>

    <main class="app-content container-fluid">
      <div class="container-xxl">
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
          <h4 id="ticket-title" class="mb-0">Chamado</h4>
          <span class="text-muted">Cliente: <span id="ticket-client">-</span></span>
          <button id="btn-claim" class="btn btn-sm btn-outline-primary d-none"><i class="bi bi-hand-index"></i> Assumir</button>
        </div>

        <div class="card p-3 mb-3">
          <div class="row g-3">
            <div class="col-12 col-md-3">
              <label class="form-label">Status</label>
              <select id="select-status" class="form-select">
                <option>Aberto</option>
                <option>Em andamento</option>
                <option>Resolvido</option>
                <option>Atrasado</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Prioridade</label>
              <select id="select-priority" class="form-select">
                <option>Baixa</option>
                <option>Média</option>
                <option>Alta</option>
                <option>Urgente</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Responsável</label>
              <select id="select-assignee" class="form-select">
                <option>Não atribuído</option>
                <option>João Silva</option>
                <option>Maria Souza</option>
                <option>Ana Lima</option>
                <option>Pedro Alves</option>
              </select>
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end gap-2">
              <button id="btn-close" class="btn btn-success flex-fill"><i class="bi bi-check2"></i> Encerrar</button>
              <button id="btn-reopen" class="btn btn-outline-warning flex-fill"><i class="bi bi-arrow-counterclockwise"></i> Reabrir</button>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100">
              <h6>Histórico</h6>
              <div id="t-timeline" class="timeline"></div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3 h-100 d-flex flex-column">
              <h6>Chat</h6>
              <div id="chat-messages" class="flex-grow-1 overflow-auto p-2" style="background:#f8fafc;border-radius:.5rem; min-height:220px;"></div>
              <form id="chat-form" class="d-flex gap-2 pt-2">
                <button class="btn btn-outline-secondary" type="button" title="Anexar"><i class="bi bi-paperclip"></i></button>
                <input id="chat-input" class="form-control" placeholder="Digite uma mensagem...">
                <button class="btn btn-primary" type="submit" title="Enviar"><i class="bi bi-send"></i></button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/data.js"></script>
  <script src="../assets/js/app.js"></script>
  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const id = parseInt(qs.get('id')||'0',10);
      const me = (JSON.parse(localStorage.getItem('profile')||'{}').name || 'João Silva');
      const data = (window.mockData?.tickets||[]);
      const t = data.find(x=>x.id===id);
      if(!t){ document.querySelector('main .container-xxl').innerHTML='<div class="alert alert-warning">Chamado não encontrado.</div>'; return; }
      // Cabeçalho + selects
      document.getElementById('ticket-title').textContent = t.title;
      document.getElementById('ticket-client').textContent = t.client;
      const selStatus = document.getElementById('select-status');
      const selPrior  = document.getElementById('select-priority');
      const selAssign = document.getElementById('select-assignee');
      selStatus.value = t.status;
      selPrior.value  = t.priority;
      // Garante que o usuário atual apareça na lista de responsáveis
      if(![...selAssign.options].some(o=>o.value===me)){
        const opt=document.createElement('option'); opt.value=me; opt.textContent=me; selAssign.appendChild(opt);
      }
      selAssign.value = t.assignee;
      // Exibe botão Assumir se não estiver atribuído ou for de outro
      const btnClaim = document.getElementById('btn-claim');
      const refreshClaimVisibility = () => {
        if(!t.assignee || t.assignee.toLowerCase() !== me.toLowerCase()) btnClaim.classList.remove('d-none');
        else btnClaim.classList.add('d-none');
      };
      refreshClaimVisibility();
      btnClaim.addEventListener('click', ()=>{
        t.assignee = me;
        selAssign.value = me;
        t.history = t.history || [];
        t.history.unshift({ author: 'Você', text: 'assumiu o chamado', time: new Date().toLocaleString() });
        renderTimeline();
        refreshClaimVisibility();
      });
      selStatus.addEventListener('change',()=>{ 
        t.status = selStatus.value; 
        t.history = t.history || []; 
        t.history.unshift({ author: 'Você', text: `alterou o status para ${t.status}`, time: new Date().toLocaleString() });
        renderTimeline(); 
      });
      selPrior.addEventListener('change',()=>{ 
        t.priority = selPrior.value; 
        t.history = t.history || []; 
        t.history.unshift({ author: 'Você', text: `alterou a prioridade para ${t.priority}`, time: new Date().toLocaleString() });
        renderTimeline(); 
      });
      selAssign.addEventListener('change',()=>{ 
        t.assignee = selAssign.value; 
        t.history = t.history || []; 
        t.history.unshift({ author: 'Você', text: `atribuiu para ${t.assignee}`, time: new Date().toLocaleString() });
        renderTimeline();
        refreshClaimVisibility();
      });

      // Linha do tempo
      const timeline = document.getElementById('t-timeline');
      const renderTimeline = ()=>{
        timeline.innerHTML='';
        (t.history||[]).forEach(h=>{
          const it = document.createElement('div');
          it.className = 'timeline-item';
          it.innerHTML = `<div><strong>${h.author}</strong> ${h.text}</div><div class="time">${h.time||''}</div>`;
          timeline.appendChild(it);
        });
      };
      renderTimeline();

      // Chat (mesmo estilo do gerente)
      const chatBox = document.getElementById('chat-messages');
      const renderChat = () => {
        if(!chatBox) return;
        chatBox.innerHTML = '';
        (t.chat || []).forEach(m => {
          const wrap = document.createElement('div');
          const isMe = (m.role === 'agent') || ((m.author||'').toLowerCase() === me.toLowerCase());
          wrap.className = 'chat-msg ' + (isMe ? 'me' : 'other');
          wrap.innerHTML = `<div class="bubble"><div class="text">${m.text}</div><div class="time">${m.time||''}</div></div>`;
          chatBox.appendChild(wrap);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      };
      renderChat();
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      chatForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = chatInput.value.trim(); if (!text) return;
        (t.chat = t.chat || []).push({ role: 'agent', author: 'Você', time: new Date().toLocaleString(), text });
        chatInput.value = '';
        renderChat();
      });

      // Ações Encerrar/Reabrir
      document.getElementById('btn-close')?.addEventListener('click', ()=>{
        t.status = 'Resolvido';
        selStatus.value = t.status;
        t.history = t.history || [];
        t.history.unshift({ author: 'Você', text: 'encerrou o chamado', time: new Date().toLocaleString() });
        renderTimeline();
      });
      document.getElementById('btn-reopen')?.addEventListener('click', ()=>{
        t.status = 'Aberto';
        selStatus.value = t.status;
        t.history = t.history || [];
        t.history.unshift({ author: 'Você', text: 'reabriu o chamado', time: new Date().toLocaleString() });
        renderTimeline();
      });

      // Auto-injeção de mensagem da IA (sem formulário visível)
      (function injectIaIntake(){
        const already = (t.history||[]).some(h => (h.text||'').toLowerCase().includes('solicitação inicial'));
        if (already) return; // não duplicar
        const now = new Date().toLocaleString();
        // tenta inferir uma descrição inicial vinda do cliente (se existir)
        const initialDesc = (t.history||[]).find(h => (h.author||'').toLowerCase().includes('cliente') || (h.text||'').toLowerCase().includes('descrição'))?.text || '-';
        t.history = t.history || [];
        t.history.unshift({ author: 'IA', text: `Encaminhado para ${t.assignee || 'NÃO DEFINIDO'}`, time: now });
        t.history.unshift({ author: 'IA', text: 'Recebi a solicitação do usuário e coletei as informações iniciais.', time: now });
        t.history.unshift({ author: 'IA', text: `Solicitação inicial — Nome: ${t.client || '-'}; Título: ${t.title || '-'}; Descrição: ${initialDesc || '-'}`, time: now });
        // Reflete no chat como mensagem automática da IA
        (t.chat = t.chat || []).unshift({ role: 'system', author: 'IA', time: now, text: 'Nova solicitação recebida e encaminhada ao atendente.' });
        renderTimeline();
        renderChat();
      })();

      try{ renderNotifications(); }catch{}
    })();
  </script>
</body>
</html>
