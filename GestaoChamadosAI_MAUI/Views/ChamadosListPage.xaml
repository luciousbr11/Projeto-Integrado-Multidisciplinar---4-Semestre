<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GestaoChamadosAI_MAUI.ViewModels"
             xmlns:models="clr-namespace:GestaoChamadosAI_MAUI.Models"
             x:Class="GestaoChamadosAI_MAUI.Views.ChamadosListPage"
             x:DataType="vm:ChamadosListViewModel"
             Title="Chamados">

    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto">

        <!-- Header com Logo e Voltar -->
        <Grid Grid.Row="0" BackgroundColor="{StaticResource Primary}" Padding="15" ColumnDefinitions="Auto,*,Auto">
            <Image Grid.Column="0"
                   Source="logo.png"
                   WidthRequest="35"
                   HeightRequest="35"
                   VerticalOptions="Center"/>
            
            <Button Grid.Column="2"
                    Text="â† Voltar"
                    Command="{Binding VoltarCommand}"
                    HeightRequest="45"
                    WidthRequest="120"
                    FontSize="16"
                    BackgroundColor="{StaticResource Gray700}"
                    TextColor="White"
                    CornerRadius="8"
                    Padding="10,0"/>
        </Grid>

        <!-- Filtros -->
        <Frame Grid.Row="1" 
               Margin="10,5,10,10"
               Padding="15"
               BackgroundColor="White"
               BorderColor="{StaticResource Primary}"
               CornerRadius="10"
               HasShadow="True">
            <VerticalStackLayout Spacing="10">
                <!-- Filtro Status -->
                <HorizontalStackLayout Spacing="15">
                    <Label Text="Status:" 
                           VerticalOptions="Center"
                           FontAttributes="Bold"
                           FontSize="16"
                           WidthRequest="90"
                           TextColor="{StaticResource Gray900}"/>
                    <Picker ItemsSource="{Binding StatusOptions}"
                            SelectedItem="{Binding SelectedStatus}"
                            HorizontalOptions="FillAndExpand"
                            FontSize="15"
                            TextColor="{StaticResource Gray900}"
                            BackgroundColor="Transparent"/>
                </HorizontalStackLayout>

                <!-- Filtro Prioridade -->
                <HorizontalStackLayout Spacing="15">
                    <Label Text="Prioridade:" 
                           VerticalOptions="Center"
                           FontAttributes="Bold"
                           FontSize="16"
                           WidthRequest="90"
                           TextColor="{StaticResource Gray900}"/>
                    <Picker ItemsSource="{Binding PrioridadeOptions}"
                            SelectedItem="{Binding SelectedPrioridade}"
                            HorizontalOptions="FillAndExpand"
                            FontSize="15"
                            TextColor="{StaticResource Gray900}"
                            BackgroundColor="Transparent"/>
                </HorizontalStackLayout>

                <!-- Filtro Suporte -->
                <HorizontalStackLayout Spacing="15">
                    <Label Text="Suporte:" 
                           VerticalOptions="Center"
                           FontAttributes="Bold"
                           FontSize="16"
                           WidthRequest="90"
                           TextColor="{StaticResource Gray900}"/>
                    <Picker ItemsSource="{Binding Suportes}"
                            SelectedItem="{Binding SelectedSuporte}"
                            ItemDisplayBinding="{Binding Nome}"
                            HorizontalOptions="FillAndExpand"
                            FontSize="14"
                            TextColor="{StaticResource Gray900}"
                            BackgroundColor="Transparent"/>
                </HorizontalStackLayout>

                <!-- BotÃ£o Limpar Filtros -->
                <Button Text="ðŸ”„ Limpar Todos os Filtros"
                        Command="{Binding ClearFiltersCommand}"
                        BackgroundColor="#FF6B6B"
                        TextColor="White"
                        HeightRequest="48"
                        FontSize="14"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        Margin="0,10,0,0"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Lista de Chamados -->
        <RefreshView Grid.Row="3"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">
            <CollectionView ItemsSource="{Binding Chamados}"
                           RemainingItemsThreshold="5"
                           RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">
                <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChamadoListItem">
                    <Frame Margin="10,5"
                           Padding="15"
                           CornerRadius="10"
                           HasShadow="False"
                           BorderColor="{StaticResource Gray200}"
                           BackgroundColor="White">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ChamadosListViewModel}}, Path=NavigateToDetalhesCommand}"
                                CommandParameter="{Binding .}"/>
                        </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="*,Auto" 
                                  RowDefinitions="Auto,Auto,Auto,Auto">
                                
                                <!-- TÃ­tulo -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding Titulo}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray900}"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="2"/>

                                <!-- Status Badge -->
                                <Frame Grid.Row="0" Grid.Column="1"
                                       Padding="8,4"
                                       CornerRadius="5"
                                       HasShadow="False"
                                       BackgroundColor="{StaticResource Primary}"
                                       VerticalOptions="Start">
                                    <Label Text="{Binding Status}"
                                           FontSize="12"
                                           TextColor="White"
                                           FontAttributes="Bold"/>
                                </Frame>

                                <!-- Nome do UsuÃ¡rio -->
                                <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="{Binding UsuarioNome, StringFormat='ðŸ‘¤ Cliente: {0}'}"
                                       FontSize="14"
                                       TextColor="{StaticResource Gray700}"
                                       Margin="0,5,0,0"
                                       LineBreakMode="TailTruncation"/>

                                <!-- Prioridade -->
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Spacing="8" Margin="0,5,0,0">
                                    <Frame Padding="6,3" CornerRadius="5" HasShadow="False" BackgroundColor="{Binding Prioridade, Converter={StaticResource PrioridadeToColorConverter}}">
                                        <Label Text="{Binding Prioridade}" FontSize="11" TextColor="White" FontAttributes="Bold"/>
                                    </Frame>
                                </HorizontalStackLayout>

                                <!-- Data -->
                                <Label Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="{Binding DataAbertura, StringFormat='ðŸ“… Aberto em: {0:dd/MM/yyyy HH:mm}'}"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray500}"
                                       Margin="0,5,0,0"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                       HorizontalOptions="Center"
                                       Padding="50">
                        <Label Text="ðŸ“‹"
                               FontSize="64"
                               HorizontalOptions="Center"/>
                        <Label Text="Nenhum chamado encontrado"
                               FontSize="18"
                               TextColor="{StaticResource Gray500}"
                               HorizontalOptions="Center"
                               Margin="0,10,0,0"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- BotÃ£o Novo Chamado -->
        <Button Grid.Row="3"
                Text="âž• Novo Chamado"
                Command="{Binding NavigateToNovoChamadoCommand}"
                Margin="20"
                HeightRequest="56"
                FontSize="18"
                FontAttributes="Bold"
                BackgroundColor="{StaticResource Success}"
                VerticalOptions="End"/>

        <!-- Loading -->
        <ActivityIndicator Grid.Row="2"
                         IsRunning="{Binding IsLoading}"
                         IsVisible="{Binding IsLoading}"
                         Color="{StaticResource Primary}"
                         VerticalOptions="Center"
                         HorizontalOptions="Center"/>
    </Grid>

</ContentPage>
